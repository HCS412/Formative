name: Dependency Guardian
on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:
  push:
    paths:
      - 'package-lock.json'

permissions:
  contents: write
  pull-requests: write
  security-events: write
  issues: write

jobs:
  scan:
    name: Scan Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Security Audit
        id: audit
        run: |
          npm audit --audit-level=moderate 2>&1 | tee audit-output.txt
        continue-on-error: true

      - name: Check for Outdated
        id: outdated
        run: |
          npm outdated 2>&1 | tee outdated-output.txt
        continue-on-error: true

      - name: Dependency Guardian Report
        uses: actions/github-script@v7
        env:
          BAMBOO_AGENT_ID: ${{ secrets.BAMBOO_AGENT_ID }}          BAMBOO_AGENT_SECRET: ${{ secrets.BAMBOO_AGENT_SECRET }}          AUDIT_OUTCOME: ${{ steps.audit.outcome }}          OUTDATED_OUTCOME: ${{ steps.outdated.outcome }}        with:
          script: |
            const fs = require('fs');
            const agentId = process.env.BAMBOO_AGENT_ID;
            const agentSecret = process.env.BAMBOO_AGENT_SECRET;
            const auditPassed = process.env.AUDIT_OUTCOME === 'success';
            const outdatedPassed = process.env.OUTDATED_OUTCOME === 'success';

            // Read outputs
            let auditOutput = '';
            let outdatedOutput = '';
            try {
              auditOutput = fs.readFileSync('audit-output.txt', 'utf8');
            } catch (e) {}
            try {
              outdatedOutput = fs.readFileSync('outdated-output.txt', 'utf8');
            } catch (e) {}

            // If all checks passed, no action needed
            if (auditPassed) {
              console.log('All security checks passed!');
              return;
            }

            // Check for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependencies',
              state: 'open'
            });

            // If no BambooSnow secrets, create basic issue
            if (!agentId || !agentSecret) {
              if (existingIssues.data.length === 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ”’ Security Vulnerabilities Detected',
                  body: `Dependency Guardian has detected security vulnerabilities in your dependencies.\\n\\nPlease run \`npm audit --audit-level=moderate\` locally and address the issues.\\n\\n<details>\\n<summary>Audit Output</summary>\\n\\n\`\`\`\\n${auditOutput.slice(0, 5000)}\\n\`\`\`\\n</details>\\n\\n---\\n*Add BAMBOO_AGENT_ID and BAMBOO_AGENT_SECRET secrets for AI-powered analysis*\\nðŸ¤– Generated by Dependency Guardian`,
                  labels: ['security', 'dependencies']
                });
              }
              return;
            }

            // Call BambooSnow API for AI analysis
            const response = await fetch('https://api.bamboosnow.co/api/v1/runtime/dependency-analysis', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Agent-Secret': agentSecret
              },
              body: JSON.stringify({
                agent_id: agentId,
                repository: `${context.repo.owner}/${context.repo.repo}`,
                audit_output: auditOutput,
                outdated_output: outdatedOutput,
                vulnerabilities_found: !auditPassed
              })
            });

            if (!response.ok) {
              console.log('API Error:', await response.text());
              if (existingIssues.data.length === 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸ”’ Security Vulnerabilities Detected',
                  body: `Dependency Guardian has detected security vulnerabilities.\\n\\n<details>\\n<summary>Audit Output</summary>\\n\\n\`\`\`\\n${auditOutput.slice(0, 5000)}\\n\`\`\`\\n</details>\\n\\nðŸ¤– Generated by Dependency Guardian`,
                  labels: ['security', 'dependencies']
                });
              }
              return;
            }

            const analysis = await response.json();

            // Build detailed issue body
            const riskIcon = {
              'critical': 'ðŸ”´',
              'high': 'ðŸŸ ',
              'medium': 'ðŸŸ¡',
              'low': 'ðŸŸ¢',
              'none': 'âœ…'
            }[analysis.risk_level] || 'âš ï¸';

            let body = `## ${riskIcon} Dependency Security Report\\n\\n**Risk Level:** ${analysis.risk_level.toUpperCase()}\\n\\n${analysis.summary}\\n\\n`;

            if (analysis.vulnerabilities && analysis.vulnerabilities.length > 0) {
              body += `### Vulnerabilities Found\\n\\n| Package | Severity | Current | Fixed | Description |\\n|---------|----------|---------|-------|-------------|\\n`;
              for (const vuln of analysis.vulnerabilities.slice(0, 20)) {
                body += `| ${vuln.package} | ${vuln.severity} | ${vuln.current_version || '-'} | ${vuln.fixed_version || '-'} | ${vuln.description || '-'} |\\n`;
              }
              body += `\\n`;
            }

            if (analysis.update_recommendations && analysis.update_recommendations.length > 0) {
              body += `### Recommended Actions\\n\\n`;
              for (const rec of analysis.update_recommendations) {
                const icon = rec.priority === 'immediate' ? 'ðŸ”´' : rec.priority === 'soon' ? 'ðŸŸ¡' : 'ðŸŸ¢';
                body += `${icon} **${rec.action.toUpperCase()}** \`${rec.package}\`\\n${rec.reason}\\n\\n`;
              }
            }

            body += `<details>\\n<summary>Full Audit Output</summary>\\n\\n\`\`\`\\n${auditOutput.slice(0, 5000)}\\n\`\`\`\\n</details>\\n\\n`;
            body += `---\\n*Analyzed using ${analysis.tokens_used} tokens*\\nðŸ¤– Generated by [BambooSnow](https://bamboosnow.co) Dependency Guardian`;

            // Create or update issue
            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body
              });
              console.log(`Updated existing issue #${existingIssues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ ${analysis.risk_level.toUpperCase()} Risk: Security Vulnerabilities Detected`,
                body,
                labels: ['security', 'dependencies']
              });
              console.log(`Created issue #${issue.data.number}`);
            }