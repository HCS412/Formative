name: Security Scanner
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret Scanning
        id: secrets
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          extra_args: --only-verified

      - name: Dependency Scan
        id: deps
        run: |
          npm audit --audit-level=moderate 2>&1 | tee audit-output.txt
        continue-on-error: true

      - name: Security Scanner Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          BAMBOO_AGENT_ID: ${{ secrets.BAMBOO_AGENT_ID }}          BAMBOO_AGENT_SECRET: ${{ secrets.BAMBOO_AGENT_SECRET }}          SECRETS_OUTCOME: ${{ steps.secrets.outcome }}          DEPS_OUTCOME: ${{ steps.deps.outcome }}        with:
          script: |
            const fs = require('fs');
            const agentId = process.env.BAMBOO_AGENT_ID;
            const agentSecret = process.env.BAMBOO_AGENT_SECRET;
            const secretsSafe = process.env.SECRETS_OUTCOME === 'success';
            const depsSafe = process.env.DEPS_OUTCOME === 'success';

            // Read audit output
            let auditOutput = '';
            try {
              auditOutput = fs.readFileSync('audit-output.txt', 'utf8');
            } catch (e) {
              auditOutput = 'Audit output not available';
            }

            // If all checks passed, post simple success message
            if (secretsSafe && depsSafe) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ‚úÖ Security Scanner Report\\n\\nAll security checks passed!\\n\\n- Secret Scan: ‚úÖ\\n- Dependency Scan: ‚úÖ\\n\\nü§ñ Generated by [BambooSnow](https://bamboosnow.co) Security Scanner`
              });
              return;
            }

            // If no BambooSnow secrets, show basic failure message
            if (!agentId || !agentSecret) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ‚ö†Ô∏è Security Scanner Report\\n\\nSome security issues detected. Add BAMBOO_AGENT_ID and BAMBOO_AGENT_SECRET secrets for AI-powered analysis.\\n\\n- Secret Scan: ${secretsSafe ? '‚úÖ' : '‚ö†Ô∏è'}\\n- Dependency Scan: ${depsSafe ? '‚úÖ' : '‚ö†Ô∏è'}\\n\\n<details>\\n<summary>Audit Output</summary>\\n\\n\`\`\`\\n${auditOutput.slice(0, 5000)}\\n\`\`\`\\n</details>\\n\\nü§ñ Generated by Security Scanner`
              });
              return;
            }

            // Get changed files for context
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const changedFiles = files.map(f => f.filename);

            // Call BambooSnow API for AI security analysis
            const response = await fetch('https://api.bamboosnow.co/api/v1/runtime/security-scan', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Agent-Secret': agentSecret
              },
              body: JSON.stringify({
                agent_id: agentId,
                pr_number: context.issue.number,
                repository: `${context.repo.owner}/${context.repo.repo}`,
                secrets_found: !secretsSafe,
                deps_audit_passed: depsSafe,
                audit_output: auditOutput,
                changed_files: changedFiles
              })
            });

            if (!response.ok) {
              console.log('API Error:', await response.text());
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ‚ö†Ô∏è Security Scanner Report\\n\\nSome security issues detected. Unable to run AI analysis.\\n\\n- Secret Scan: ${secretsSafe ? '‚úÖ' : '‚ö†Ô∏è'}\\n- Dependency Scan: ${depsSafe ? '‚úÖ' : '‚ö†Ô∏è'}\\n\\n<details>\\n<summary>Audit Output</summary>\\n\\n\`\`\`\\n${auditOutput.slice(0, 5000)}\\n\`\`\`\\n</details>\\n\\nü§ñ Generated by Security Scanner`
              });
              return;
            }

            const analysis = await response.json();

            // Build detailed security report
            const riskIcon = {
              'critical': 'üî¥',
              'high': 'üü†',
              'medium': 'üü°',
              'low': 'üü¢',
              'none': '‚úÖ'
            }[analysis.risk_level] || '‚ö†Ô∏è';

            let body = `## ${riskIcon} Security Scanner Report\\n\\n**Risk Level:** ${analysis.risk_level.toUpperCase()}\\n\\n**Summary:** ${analysis.summary}\\n\\n`;

            body += `### Scan Results\\n- Secret Scan: ${secretsSafe ? '‚úÖ Passed' : '‚ö†Ô∏è Issues Found'}\\n- Dependency Scan: ${depsSafe ? '‚úÖ Passed' : '‚ö†Ô∏è Issues Found'}\\n\\n`;

            if (analysis.findings && analysis.findings.length > 0) {
              body += `### Findings\\n\\n`;
              for (const finding of analysis.findings) {
                const icon = finding.severity === 'critical' ? 'üî¥' : finding.severity === 'high' ? 'üü†' : finding.severity === 'medium' ? 'üü°' : 'üü¢';
                body += `${icon} **${finding.severity.toUpperCase()}** [${finding.category}]`;
                if (finding.file) body += ` in \`${finding.file}\``;
                body += `\\n${finding.description}\\n\\n`;
              }
            }

            if (analysis.recommendations && analysis.recommendations.length > 0) {
              body += `### Recommendations\\n\\n`;
              for (const rec of analysis.recommendations) {
                body += `- ${rec}\\n`;
              }
              body += `\\n`;
            }

            body += `<details>\\n<summary>Full Audit Output</summary>\\n\\n\`\`\`\\n${auditOutput.slice(0, 5000)}\\n\`\`\`\\n</details>\\n\\n`;
            body += `---\\n*Analyzed using ${analysis.tokens_used} tokens*\\nü§ñ Generated by [BambooSnow](https://bamboosnow.co) Security Scanner`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });